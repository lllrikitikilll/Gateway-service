## Разработка сервиса
Сервис шлюз для проксирования запросов по маршрутам


По умолчанию сервис будет работать по адрессу `127.0.0.1:8000`
Документация `127.0.0.1:8000/docs`

## Запуск сервиса
Для установки иcпользуется `poetry=^1.8.3`

```bash
git pull git@hub.mos.ru:shift-python/y2024/homeworks/apanin/gateway_api.git
poetry install --dev

# Устанавливаем подмодули (рекурсивно)
git submodule update --init --recurcive

# Запуск группы сервисов
docker-compose up -d
```

Применение миграций для БД
```bash
docker exec -it auth_container alembic -c src/app/db_service/alembic.ini upgrade head
```


## Структура проекта:
```bash
.
├── db                                  # Схемы бд и команды на sql
├── service_auth                        # Папка с микросервисом аутентификации.
├── service_face_vector                 # Папка с микросервисом для работы с вектором лица.
├── service_transaction                 # Папка с микросервисом для обработки транзакций.
├── setup.cfg                           # Конфигурационный файл для инструментов, flake8 и mypy.
└── src                                 # Основная папка с исходным кодом проекта.
    ├── app                             # Папка с приложением и его компонентами.
    │   ├── api                         # Папка с API-обработчиками.
    │   │   ├── auth_router.py          # Маршрутизатор для аутентификации.
    │   │   ├── healthz                 # Обработчик для проверки состояния системы.
    │   │   ├── transaction_router.py   # Маршрутизатор для обработки транзакций.
    │   │   └── verify_router.py        # Маршрутизатор для верификации.
    │   ├── client.py                   # Клиентский код для взаимодействия с внешними сервисами.
    │   ├── core                        # Основные настройки и конфигурации приложения.
    │   │   └── settings.py             # Файл с настройками приложения.
    │   ├── dependency                  # Зависимости и их обработчики.
    │   │   ├── auth_dependency.py      # Обработчики зависимостей для аутентификации.
    │   ├── main.py                     # Главный файл запуска приложения.
    │   └── schemas                     # Схемы данных для API и базы данных.
    │       ├── auth_schemas.py         # Схемы для аутентификации.
    │       ├── transaction_schemas.py  # Схемы для обработки транзакций.
    │       ├── validators.py           # Валидаторы данных.
    │       └── verify_schemas.py       # Схемы для верификации данных.
    └── tests                           # Папка с тестами для приложения.
        └── test_api_gateway.py         # Тесты для API-шлюза.

```

## Описание сервиса

Отвечает за проксирование запросов в сервисы. С помощью `docker-compose` запускается группа контейнеров отвечающих за внешние сервера и дополнительно ПО:
1. Авторизации
2. Транзакций
3. Верификации
4. БД PostgreSQL
5. Kafka И Zookeper


### Submodules
В проекте используются git submodule позволяющие использовать стороние репозитории в основном проекте отдельно (в плане работы с контролем версий)

Проект содержит сабмодули git двойной вложенности, вторая вложенность это `db_service` общий сервис для работы с БД.
`db_service` как сабмодуль был выбран как один и вариантов работы сервисов с одной БД, для их взаимосвязи в запросах к БД. `db_service` лежит отдельным репозиторием на гитлабе, для обновления `db_service` требуется:
1. клонировать проект на ПК
2. добавить изменения 
3. отправить изменения на удаленный репозиторий
4. Обновить у сервиса `gateway` подмодули

```bash
git submodule update --init --recurcive
```

### Ошибки
Исключения на стороне сервисов траслируются через `API Gateway` клиенту

### Переменные окружения проекта
Передаются в `docker-compose.yml`, указание адресов сервисов передается явно в сервисе `API Gateway`
По данным путям будет обмен информацией с сервисами
Пример
```bash
environment:
    - APP_CONFIG__url__transaction=http://transaction_container:8000
    - APP_CONFIG__url__verification=http://verification_container:8000
    - APP_CONFIG__url__auth=http://auth_container:8000
```

Для переменных интимного характера, такие как секретный ключ, алгоритм шифрования и время действия токена используется файл .env (`.env-dev` в данном проекте) который указывается в `docker-compose.yml`.
Пример:
```bash
`docker-compose.yml`
env_file:
    - .env-dev

`.env-dev`
APP_CONFIG__JWT__algorithm=HS256
APP_CONFIG__JWT__secret_key=SECRETKEY
APP_CONFIG__JWT__access_token_expire_minutes=30
```


